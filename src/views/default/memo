<script>
    // 수정 상태로 전환
    function toggleEdit(todoId) {
        const todoTitle = document.getElementById(`todo_title-${todoId}`);
        const editBtn = document.getElementById(`edit-btn-${todoId}`);
        
        if (todoTitle.contentEditable === "true") {
            // 수정 상태 -> 저장
            const newTitle = todoTitle.textContent;
            const newPriority = document.querySelector(`input[name='priority-${todoId}']:checked`).value;
            
            fetch('/todo/modify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ T_ID: todoId, T_TITLE: newTitle, T_PRIORITY: newPriority })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("수정 완료!");
                    todoTitle.contentEditable = false;
                    editBtn.innerHTML = '수정';
                } else {
                    alert("수정 실패!");
                }
            });
        } else {
            // 읽기 상태 -> 수정 가능
            todoTitle.contentEditable = true;
            editBtn.innerHTML = '저장';
        }
    }
</script>

<div id="todo">
    <div name="title">To-Do</div>
    <form action="/todo/newtodo" method="post" id="todoform">
        <textarea name="T_TITLE" id="title" maxlength="13" placeholder="제목" required></textarea>
        <select name="T_PRIORITY" id="priority" required>
            <option value="priority" selected disabled hidden>우선순위</option>
            <option value="0">없음</option>
            <option value="1">낮음</option>
            <option value="2">중간</option>
            <option value="3">높음</option>
        </select>
        <input type="hidden" name="U_ID" value="U_ID">
        <input type="submit" value="등록">
    </form>

    <div id="todo-list">
        <% todo.forEach(item => { %>
            <div id="todo-item-<%= item.T_ID %>">
                <div class="todo-item">
                    <% if (item.T_PRIORITY == '1') { %> ! <% } %>
                    <% if (item.T_PRIORITY == '2') { %> !! <% } %>
                    <% if (item.T_PRIORITY == '3') { %> !!! <% } %>
                    <div id="todo_title-<%= item.T_ID %>"><%= item.T_TITLE %></div>
                    <input type="checkbox" name="<%= item.T_ID %>" id="todo_checkbox-<%= item.T_ID %>">
                </div>

                <button id="edit-btn-<%= item.T_ID %>" onclick="toggleEdit(<%= item.T_ID %>)">
                    수정
                </button>

                <form action="/todo/delete" method="post" style="display:inline;">
                    <input type="hidden" name="T_TITLE" value="<%= item.T_TITLE %>">
                    <button type="submit">삭제</button>
                </form>
            </div>
        <% }) %>
    </div>
</div>