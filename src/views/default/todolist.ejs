<script>
    const checked=(this, num)=>{
        const todo=<%- JSON.stringify(todo) %>;
        console.log('this',this);
        console.log('todo',todo);
        console.log('num',num);
    }
    // 수정 상태로 전환
    function enableEdit(todoId) {
        const todoTitle = document.getElementById(`todo_title-${todoId}`);
        const editBtn = document.getElementById(`edit-btn-${todoId}`);
        
        // todo_title을 수정 가능하게 만듬
        todoTitle.contentEditable = true;
        todoTitle.style.backgroundColor = '#f0f0f0'; // 수정할 때 배경 색상 변경

        // 버튼 텍스트를 '저장'으로 변경
        editBtn.innerHTML = '저장';
        editBtn.setAttribute('onclick', `saveEdit(${todoId})`);
    }

    // 수정된 내용 저장
    function saveEdit(todoId) {
        const todoTitle = document.getElementById(`todo_title-${todoId}`);
        const newTitle = todoTitle.textContent; // 수정된 텍스트 가져오기
        const newPriority = document.querySelector(`input[name='priority-${todoId}']:checked`).value;

        // 수정된 내용을 서버로 전송
        fetch('/todo/modify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                T_ID: todoId,
                T_TITLE: newTitle,
                T_PRIORITY: newPriority
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("수정 완료!");
                todoTitle.contentEditable = false; // 수정 불가 상태로 변경
                todoTitle.style.backgroundColor = ''; // 배경 색상 초기화
                const editBtn = document.getElementById(`edit-btn-${todoId}`);
                editBtn.innerHTML = '수정'; // 버튼 텍스트를 '수정'으로 변경
                editBtn.setAttribute('onclick', `enableEdit(${todoId})`); // 다시 수정 버튼으로 전환
            } else {
                alert("수정 실패!");
            }
        });
    }
</script>

<div id="inside_wrap">
    <div id="todo">
        <div name="title">To-Do</div>
        <form action="/todo/newtodo" method="post" id="todoform">
            <textarea name="T_TITLE" id="title" maxlength="13" placeholder="제목" required></textarea>
            <select name="T_PRIORITY" id="priority" required>
                <option value="priority" selected disabled hidden>우선순위</option>
                <option value="0">없음</option>
                <option value="1">낮음</option>
                <option value="2">중간</option>
                <option value="3">높음</option>
            </select>
            <input type="hidden" name="U_ID" value="U_ID">
            <input type="submit" value="등록">
        </form>

        <% for (i=0;i<todo.length;i++) { %>
            <div id="todolist">
                <div id="todo_wrap">
                    <label for="todo_checkbox">
                        <div id="label_bg">
                            <div id="label_btn"></div>
                        </div>
                    </label>
                    <% if(todo[i]['T_PRIORITY']=='1') { %>
                        !
                    <% } else if(todo[i]['T_PRIORITY']=='2'){ %>
                        !!
                    <% } else if(todo[i]['T_PRIORITY']=='3') { %>
                        !!!
                    <% } else { %>
                    <% } %>
                    <div name="title" id="todo_title-<%= todo[i].T_ID %>"><%= todo[i]['T_TITLE'] %></div>
                    <input type="checkbox" name="<%= todo[i]['T_ID'] %>" id="todo_checkbox">
                </div>

                <div class="icon">
                    <button type="button" id="edit-btn-<%= todo[i].T_ID %>" onclick="enableEdit(<%= todo[i].T_ID %>)" style="border:none; background:none;">
                        수정
                    </button>

                    <form action="/todo/delete" method="post" style="display:inline;">
                        <input type="hidden" name="T_TITLE" value="<%= todo[i].T_TITLE %>">
                        <button type="submit" style="border:none; background:none; padding:0;">
                            <svg width="13px" height="13px" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 2H1V4H15V2H12V0H4V2Z" fill="rgb(100, 100, 100)"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M3 6H13V16H3V6ZM7 9H9V13H7V9Z" fill="rgb(100, 100, 100)"/>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        <% } %>
    </div>
</div>
